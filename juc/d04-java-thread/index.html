<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"lsy.cool","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.9.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="线程的创建和运行、常用方法、运行原理等。">
<meta property="og:type" content="article">
<meta property="og:title" content="并发编程（四）爪哇之线程">
<meta property="og:url" content="https://lsy.cool/juc/d04-java-thread/index.html">
<meta property="og:site_name" content="拾予">
<meta property="og:description" content="线程的创建和运行、常用方法、运行原理等。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lsy.cool/juc/d04-java-thread/jstack.png">
<meta property="og:image" content="https://lsy.cool/juc/d04-java-thread/java-stack-thread-frame.png">
<meta property="og:image" content="https://lsy.cool/juc/d04-java-thread/debug-single-thread-frames.png">
<meta property="og:image" content="https://lsy.cool/juc/d04-java-thread/debug-multi-thread-frames.png">
<meta property="og:image" content="https://lsy.cool/juc/d04-java-thread/thread-join.png">
<meta property="og:image" content="https://lsy.cool/juc/d04-java-thread/thread-five-system-state.png">
<meta property="og:image" content="https://lsy.cool/juc/d04-java-thread/thread-six-system-state.png">
<meta property="og:image" content="https://lsy.cool/juc/d04-java-thread/plan-as-a-whole1.png">
<meta property="og:image" content="https://lsy.cool/juc/d04-java-thread/plan-as-a-whole2.png">
<meta property="article:published_time" content="2021-05-06T05:40:32.000Z">
<meta property="article:modified_time" content="2022-06-14T07:24:49.978Z">
<meta property="article:author" content="Long Shiyu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lsy.cool/juc/d04-java-thread/jstack.png">


<link rel="canonical" href="https://lsy.cool/juc/d04-java-thread/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://lsy.cool/juc/d04-java-thread/","path":"juc/d04-java-thread/","title":"并发编程（四）爪哇之线程"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>并发编程（四）爪哇之线程 | 拾予</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">拾予</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Shiyu's Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">1</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">6</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">13</span></a></li>
        <li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%92%8C%E8%BF%90%E8%A1%8C%E7%BA%BF%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">创建和运行线程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Thread-%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B"><span class="nav-number">1.1.</span> <span class="nav-text">使用 Thread 创建线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Runnable-%E9%85%8D%E5%90%88-Thread-%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="nav-number">1.2.</span> <span class="nav-text">使用 Runnable 配合 Thread 创建线程（推荐）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-FutureTask-%E9%85%8D%E5%90%88-Thread"><span class="nav-number">1.3.</span> <span class="nav-text">使用 FutureTask 配合 Thread</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B%E5%88%B0%E5%BA%95%E6%9C%89%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="nav-number">1.4.</span> <span class="nav-text">创建线程到底有几种方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E8%BF%90%E8%A1%8C%E7%8E%B0%E8%B1%A1"><span class="nav-number">1.5.</span> <span class="nav-text">多线程运行现象</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E7%BA%BF%E7%A8%8B%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">2.</span> <span class="nav-text">查看线程的方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Windows"><span class="nav-number">2.1.</span> <span class="nav-text">Windows</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux"><span class="nav-number">2.2.</span> <span class="nav-text">Linux</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Java"><span class="nav-number">2.3.</span> <span class="nav-text">Java</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="nav-number">3.</span> <span class="nav-text">线程运行原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A0%88%E4%B8%8E%E6%A0%88%E5%B8%A7"><span class="nav-number">3.1.</span> <span class="nav-text">虚拟机栈与栈帧</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2%EF%BC%88Thread-Context-Switch%EF%BC%89"><span class="nav-number">3.2.</span> <span class="nav-text">线程上下文切换（Thread Context Switch）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%B8%B8%E8%A7%81%E6%96%B9%E6%B3%95"><span class="nav-number">4.</span> <span class="nav-text">线程常见方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#start-%E4%B8%8E-run"><span class="nav-number">4.1.</span> <span class="nav-text">start 与 run</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sleep-%E4%B8%8E-yield"><span class="nav-number">4.2.</span> <span class="nav-text">sleep 与 yield</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#sleep"><span class="nav-number">4.2.1.</span> <span class="nav-text">sleep</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#yield"><span class="nav-number">4.2.2.</span> <span class="nav-text">yield</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8C%BA%E5%88%AB"><span class="nav-number">4.2.3.</span> <span class="nav-text">区别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%94%E7%94%A8"><span class="nav-number">4.2.4.</span> <span class="nav-text">应用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#join"><span class="nav-number">4.3.</span> <span class="nav-text">join</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#join-%E4%BD%BF%E7%94%A8"><span class="nav-number">4.3.1.</span> <span class="nav-text">join 使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#join-%E5%A4%9A%E4%B8%AA"><span class="nav-number">4.3.2.</span> <span class="nav-text">join 多个</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#join-%E6%97%B6%E6%95%88"><span class="nav-number">4.3.3.</span> <span class="nav-text">join 时效</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#interrupt"><span class="nav-number">4.4.</span> <span class="nav-text">interrupt</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%93%E6%96%AD%E9%98%BB%E5%A1%9E%E7%8A%B6%E6%80%81%E7%BA%BF%E7%A8%8B"><span class="nav-number">4.4.1.</span> <span class="nav-text">打断阻塞状态线程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%93%E6%96%AD%E6%AD%A3%E5%B8%B8%E8%BF%90%E8%A1%8C%E7%BA%BF%E7%A8%8B"><span class="nav-number">4.4.2.</span> <span class="nav-text">打断正常运行线程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#interrupt-%E5%92%8C-interrupted"><span class="nav-number">4.4.3.</span> <span class="nav-text">interrupt 和 interrupted</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#interrupt-%E5%92%8C-park"><span class="nav-number">4.4.4.</span> <span class="nav-text">interrupt 和 park</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%A4%E9%98%B6%E6%AE%B5%E7%BB%88%E6%AD%A2%E6%A8%A1%E5%BC%8F"><span class="nav-number">4.4.5.</span> <span class="nav-text">两阶段终止模式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%97%B6%E4%B8%8D%E6%8E%A8%E8%8D%90%E4%BD%BF%E7%94%A8%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">5.</span> <span class="nav-text">过时不推荐使用的方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%9E%E5%AE%88%E6%8A%A4%E7%BA%BF%E7%A8%8B%E4%B8%8E%E5%AE%88%E6%8A%A4%E7%BA%BF%E7%A8%8B"><span class="nav-number">6.</span> <span class="nav-text">非守护线程与守护线程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E4%BA%94%E5%A4%A7%E7%8A%B6%E6%80%81"><span class="nav-number">7.</span> <span class="nav-text">线程五大状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%85%AD%E5%A4%A7%E7%8A%B6%E6%80%81"><span class="nav-number">8.</span> <span class="nav-text">线程六大状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%9F%E7%AD%B9%E6%96%B9%E6%B3%95%E5%BA%94%E7%94%A8"><span class="nav-number">9.</span> <span class="nav-text">统筹方法应用</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Long Shiyu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Long Shiyu</p>
  <div class="site-description" itemprop="description">少无适俗韵，性本爱丘山</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/islongshiyu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;islongshiyu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:islongshiyu@gmail.com" title="E-Mail → mailto:islongshiyu@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://unpkg.com/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/islongshiyu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lsy.cool/juc/d04-java-thread/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Long Shiyu">
      <meta itemprop="description" content="少无适俗韵，性本爱丘山">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拾予">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          并发编程（四）爪哇之线程
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-06 13:40:32" itemprop="dateCreated datePublished" datetime="2021-05-06T13:40:32+08:00">2021-05-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-06-14 15:24:49" itemprop="dateModified" datetime="2022-06-14T15:24:49+08:00">2022-06-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/JUC/" itemprop="url" rel="index"><span itemprop="name">JUC</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>线程的创建和运行、常用方法、运行原理等。</p>
<span id="more"></span>

<h2 id="创建和运行线程"><a href="#创建和运行线程" class="headerlink" title="创建和运行线程"></a>创建和运行线程</h2><h3 id="使用-Thread-创建线程"><a href="#使用-Thread-创建线程" class="headerlink" title="使用 Thread 创建线程"></a>使用 Thread 创建线程</h3><p>直接使用 <code>Thread </code> 创建线程，这种属于继承<code>Thread </code> 类方式的使用，把线程和任务合并在了一起。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.NewAndRunThread1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewAndRunThread1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        1. 创建 Thread</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;开始运行...&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        注：养成为线程设置名称的良好习惯 源码中默认线程名称&quot;Thread-&quot; + nextThreadNum() 辨识度极低</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        t.setName(<span class="string">&quot;爪哇测试线程1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        2. 启动 Thread</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        t.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-Runnable-配合-Thread-创建线程（推荐）"><a href="#使用-Runnable-配合-Thread-创建线程（推荐）" class="headerlink" title="使用 Runnable 配合 Thread 创建线程（推荐）"></a>使用 Runnable 配合 Thread 创建线程（推荐）</h3><p>把线程和任务（要执行的代码）分开：</p>
<ul>
<li><code>Thread</code> 代表线程</li>
<li><code>Runable </code> 代表可运行的任务（线程要执行的代码）</li>
</ul>
<p>把线程和任务分开，用 <code>Runnable</code> 更容易与线程池等高级 API 配合， <code>Runnable </code> 让任务脱离了 <code>Thread</code> 继承体系，更灵活，解耦，通过查看源码可以发现，这种方式最终与第一种方式相同，最终调用<code>run()</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.NewAndRunThread2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewAndRunThread2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        1. 创建 Runnable 对象</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Runnable r = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;开始运行...&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        2. 创建 Thread</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread(r, <span class="string">&quot;爪哇测试线程2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        3. 启动 Thread</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        t.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-FutureTask-配合-Thread"><a href="#使用-FutureTask-配合-Thread" class="headerlink" title="使用 FutureTask 配合 Thread"></a>使用 FutureTask 配合 Thread</h3><p><code>FutureTask</code> 能够接收 <code>Callable</code> 类型的参数，用来处理有返回结果的情况：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.NewAndRunThread3&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewAndRunThread3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        1. 创建 FutureTask</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        FutureTask&lt;Integer&gt; ft = <span class="keyword">new</span> FutureTask&lt;Integer&gt;(<span class="keyword">new</span> Callable&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;开始运行...&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Thread.sleep(<span class="number">5000</span>);<span class="comment">//模拟耗时5秒执行任务</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        2. 创建 Thread</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread(ft, <span class="string">&quot;爪哇测试线程3&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        3. 启动 Thread</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        t.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;继续执行&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        4. 主线程获取结果（阻塞）</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        Integer result = ft.get();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;获取到任务执行完毕结果：&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Future</code> 就是对于具体的 <code>Runnable</code> 或者 <code>Callable</code> 任务的执行结果进行取消、查询是否完成、获取结果。必要时可以通过 <code>get()</code> 方法获取执行结果，该方法会阻塞直到任务返回结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Future</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCancelled</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isDone</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">V <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException</span>;</span><br><span class="line">    <span class="function">V <span class="title">get</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Future</code> 提供了三种功能：</p>
<ol>
<li>判断任务是否完成</li>
<li>能够中断任务</li>
<li>能够获取任务执行结果</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/RX5rVuGr6Ab0SmKigmZEag">FutureTask是Future和Runable的实现</a></p>
<h3 id="创建线程到底有几种方式"><a href="#创建线程到底有几种方式" class="headerlink" title="创建线程到底有几种方式"></a>创建线程到底有几种方式</h3><p>网上的面试题和各大博客对创建线程有几种方式一直存在争议，我这里贴出了两篇文章，无论是哪种说法，只要能描述清楚我觉得都是正确的。</p>
<ul>
<li>知乎：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/196789486">https://zhuanlan.zhihu.com/p/196789486</a></li>
<li>甲骨文（官方）：<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/tutorial/essential/concurrency/runthread.html">https://docs.oracle.com/javase/tutorial/essential/concurrency/runthread.html</a></li>
</ul>
<h3 id="多线程运行现象"><a href="#多线程运行现象" class="headerlink" title="多线程运行现象"></a>多线程运行现象</h3><ul>
<li>交替执行</li>
<li>执行先后顺序无法人为干预，不受控制</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.RunningMultiThread&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RunningMultiThread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;开始运行...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;线程A&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;开始运行...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;线程B&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">15:00:05.758 d04.RunningMultiThread [线程A] - 开始运行...</span><br><span class="line">15:00:05.758 d04.RunningMultiThread [线程B] - 开始运行...</span><br><span class="line">15:00:05.758 d04.RunningMultiThread [线程B] - 开始运行...</span><br><span class="line">15:00:05.758 d04.RunningMultiThread [线程B] - 开始运行...</span><br><span class="line">15:00:05.758 d04.RunningMultiThread [线程B] - 开始运行...</span><br><span class="line">15:00:05.758 d04.RunningMultiThread [线程B] - 开始运行...</span><br><span class="line">15:00:05.758 d04.RunningMultiThread [线程B] - 开始运行...</span><br><span class="line">15:00:05.758 d04.RunningMultiThread [线程B] - 开始运行...</span><br><span class="line">15:00:05.758 d04.RunningMultiThread [线程B] - 开始运行...</span><br><span class="line">15:00:05.758 d04.RunningMultiThread [线程B] - 开始运行...</span><br><span class="line">15:00:05.758 d04.RunningMultiThread [线程B] - 开始运行...</span><br><span class="line">15:00:05.758 d04.RunningMultiThread [线程A] - 开始运行...</span><br><span class="line">15:00:05.758 d04.RunningMultiThread [线程A] - 开始运行...</span><br><span class="line">15:00:05.758 d04.RunningMultiThread [线程A] - 开始运行...</span><br><span class="line">15:00:05.758 d04.RunningMultiThread [线程A] - 开始运行...</span><br><span class="line">15:00:05.758 d04.RunningMultiThread [线程B] - 开始运行...</span><br><span class="line">15:00:05.758 d04.RunningMultiThread [线程B] - 开始运行...</span><br><span class="line">15:00:05.758 d04.RunningMultiThread [线程B] - 开始运行...</span><br><span class="line">15:00:05.758 d04.RunningMultiThread [线程B] - 开始运行...</span><br></pre></td></tr></table></figure>

<h2 id="查看线程的方法"><a href="#查看线程的方法" class="headerlink" title="查看线程的方法"></a>查看线程的方法</h2><h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><ul>
<li><p>任务管理器可以查看进程和线程数，也可以用来杀死进程</p>
</li>
<li><p><code>tasklist</code> 查看进程</p>
</li>
<li><p><code>taskkill</code> 杀死进程</p>
</li>
</ul>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><ul>
<li><p><code>ps -ef</code> 查看所有进程</p>
</li>
<li><p><code>ps -fT -p &lt;PID&gt;</code> 查看某个进程 PID 的所有线程</p>
</li>
<li><p><code>kill &lt;singal&gt;</code>杀死进程</p>
</li>
<li><p><code>top</code> 按大写 H 切换是否显示线程</p>
</li>
<li><p><code>top -H -p &lt;PID&gt;</code> 查看某个进程 PID 的所有线程</p>
</li>
</ul>
<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><ul>
<li><p><code>jps</code> 查看所有 Java 进程</p>
</li>
<li><p><code>jstack &lt;PID&gt;</code> 查看某个 Java 进程 PID 的所有线程状态</p>
</li>
<li><p><code>jconsole</code> 图形界面工具，可查看某个 Java 进程中的线程运行状况</p>
</li>
</ul>
<h2 id="线程运行原理"><a href="#线程运行原理" class="headerlink" title="线程运行原理"></a>线程运行原理</h2><h3 id="虚拟机栈与栈帧"><a href="#虚拟机栈与栈帧" class="headerlink" title="虚拟机栈与栈帧"></a>虚拟机栈与栈帧</h3><p><img src="/juc/d04-java-thread/jstack.png"></p>
<p>Java Virtual Machine Stacks （Java 虚拟机栈）。</p>
<p>我们都知道 JVM 中由堆、栈、方法区所组成，其中栈内存是给谁用的呢？其实就是线程，每个线程启动后，虚拟机就会为其分配一块栈内存。</p>
<ul>
<li><p>每个栈由多个栈帧 Frame 组成，对应着每次方法调用时所占用的内存（用于存储局部变量表、操作数栈、动态链接、方法出口等信息，是属于线程的私有的）。</p>
</li>
<li><p>每个线程都会维护它自己的栈帧，每个线程只能有一个活动栈帧，对应着当前正在执行的那个方法。</p>
</li>
</ul>
<p><img src="/juc/d04-java-thread/java-stack-thread-frame.png"></p>
<p>示例代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DebugSingleThreadStackFrames</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        method1(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> y = x + <span class="number">1</span>;</span><br><span class="line">        System.out.println(y);</span><br><span class="line">        Object m = method2();</span><br><span class="line">        System.out.println(m);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">method2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object o = <span class="keyword">new</span> Object();</span><br><span class="line">        System.out.println(o);</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例代码 DEBUG 图解：</p>
<p><img src="/juc/d04-java-thread/debug-single-thread-frames.png"></p>
<h3 id="线程上下文切换（Thread-Context-Switch）"><a href="#线程上下文切换（Thread-Context-Switch）" class="headerlink" title="线程上下文切换（Thread Context Switch）"></a>线程上下文切换（Thread Context Switch）</h3><p>因为以下一些原因导致 CPU 不再执行当前的线程，转而执行另一个线程的代码：</p>
<ul>
<li><p>线程的 CPU 时间片用完(每个线程轮流执行，看前面并行的概念)。</p>
</li>
<li><p>垃圾回收（垃圾回收将暂停所有当前所有工作线程， 只剩垃圾回收线程进行垃圾回收，而工作线程暂停则会发生上下文切换）。</p>
</li>
<li><p>有更高优先级的线程需要运行。</p>
</li>
<li><p>线程自己调用了 <code>sleep</code>、<code>yield</code>、<code>wait</code>、<code>join</code>、<code>park</code>、<code>synchronized</code>、<code>lock</code> 等方法。</p>
</li>
</ul>
<p>当 Context Switch 发生时，需要由操作系统保存当前线程的状态，并恢复另一个线程的状态，Java 中对应的概念 就是程序计数器（Program Counter Register），它的作用是记住下一条 JVM 指令的执行地址，是线程私有的：</p>
<ul>
<li>状态包括程序计数器，虚拟机栈中的每个栈帧的信息，如局部变量、操作数栈、返回地址等。</li>
<li>Context Switch 频繁发生会影响性能（因此并不是线程数越多越好，当线程数量大于 CPU 核心数时，CPU 必然会进行轮流调度发生线程上下文切换，切换的越频繁越影响性能，如何设置合适的线程数）。</li>
</ul>
<p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DebugMultiThreadStackFrames</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread(() -&gt; method1(<span class="number">20</span>));</span><br><span class="line">        t.setName(<span class="string">&quot;t&quot;</span>);</span><br><span class="line">        t.start();</span><br><span class="line">        method1(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> y = x + <span class="number">1</span>;</span><br><span class="line">        System.out.println(y);</span><br><span class="line">        Object m = method2();</span><br><span class="line">        System.out.println(m);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">method2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Object();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例代码 DEBUG 图解：</p>
<p><img src="/juc/d04-java-thread/debug-multi-thread-frames.png"></p>
<p>发生上下文切换时，main线程程序计数器保存切换时的main线程状后，CPU 再开始调度执行 <code>t</code> 线程。</p>
<h2 id="线程常见方法"><a href="#线程常见方法" class="headerlink" title="线程常见方法"></a>线程常见方法</h2><table>
<thead>
<tr>
<th>方法名</th>
<th>static</th>
<th>功能说明</th>
<th>注意</th>
</tr>
</thead>
<tbody><tr>
<td><code>start()</code></td>
<td></td>
<td>启动一个新线程，在新的线程运行 <code>run()</code> 方法中的代码。</td>
<td>start 方法只是让线程进入就绪，里面代码不一定立刻运行（CPU 的时间片还没分给它）。每个线程对象的start方法只能调用一次，如果调用了多次会出现<code>IllegalThreadStateException</code>。</td>
</tr>
<tr>
<td><code>run()</code></td>
<td></td>
<td>新线程启动后会调用的方法</td>
<td>如果在构造 Thread 对象时传递了 Runnable 参数，则线程启动后会调用 Runnable 中的 run 方法，否则默认不执行任何操作。但可以创建 Thread 的子类对象，来覆盖默认行为。</td>
</tr>
<tr>
<td><code>join()</code></td>
<td></td>
<td>等待线程运行结束</td>
<td></td>
</tr>
<tr>
<td><code>join(long n)</code></td>
<td></td>
<td>等待线程运行结束，最多等待 n 毫秒。</td>
<td></td>
</tr>
<tr>
<td><code>getId(</code>)</td>
<td></td>
<td>获取线程长整型的 id。</td>
<td>id 唯一。</td>
</tr>
<tr>
<td><code>getName()</code></td>
<td></td>
<td>获取线程名</td>
<td></td>
</tr>
<tr>
<td><code>setName(String)</code></td>
<td></td>
<td>修改线程名</td>
<td></td>
</tr>
<tr>
<td><code>getPriority()</code></td>
<td></td>
<td>获取线程优先级</td>
<td></td>
</tr>
<tr>
<td><code>setPriority(int)</code></td>
<td></td>
<td>修改线程优先级</td>
<td>Java 中规定线程优先级是1~10 的整数，较大的优先级能提高该线程被 CPU 调度的机率。</td>
</tr>
<tr>
<td><code>getState()</code></td>
<td></td>
<td>获取线程状态</td>
<td>Java 中线程状态是用 6 个 <code>enum</code> 表示，分别为：<code>NEW</code>, <code>RUNNABLE</code>, <code>BLOCKED</code>, <code>WAITING</code>,<code>TIMED_WAITING</code>, <code>TERMINATED</code>。</td>
</tr>
<tr>
<td><code>isInterrupted()</code></td>
<td></td>
<td>判断是否被打断</td>
<td>不会清除 <strong>打断标记</strong>。</td>
</tr>
<tr>
<td><code>isAlive()</code></td>
<td></td>
<td>线程是否存活（还没有运行完毕）</td>
<td></td>
</tr>
<tr>
<td><code>interrupt()</code></td>
<td></td>
<td>打断线程</td>
<td>如果被打断线程正在 <code>sleep</code>，<code>wait</code> ，<code>join</code> 会导致被打断的线程抛出 <code>InterruptedException</code>，并清除 <strong>打断标记</strong> ；如果打断的正在运行的线程，则会设置 <strong>打断标记</strong> ；park 的线程被打断，也会设置 <strong>打断标记</strong>。</td>
</tr>
<tr>
<td><code>interrupted()</code></td>
<td><code>static</code></td>
<td>判断当前线程是否被打断</td>
<td>会清除<strong>打断标记</strong>。</td>
</tr>
<tr>
<td><code>currentThread()</code></td>
<td><code>static</code></td>
<td>获取当前正在执行的线程</td>
<td></td>
</tr>
<tr>
<td><code>sleep(long n)</code></td>
<td><code>static</code></td>
<td>让当前执行的线程休眠n毫秒，休眠时让出 CPU 的时间片给其它线程。</td>
<td></td>
</tr>
<tr>
<td><code>yield()</code></td>
<td><code>static</code></td>
<td>提示线程调度器让出当前线程对 CPU 的使用</td>
<td>主要是为了测试和调试。</td>
</tr>
</tbody></table>
<h3 id="start-与-run"><a href="#start-与-run" class="headerlink" title="start 与 run"></a>start 与 run</h3><p>直接调用 <code>run()</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.ThreadStartAndRun&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadStartAndRun</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;开始运行...&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                ResourceReadUtil.read(Constants.ULTRA_MAN_MP4_RES_PATH);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        t1.run();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;做其他事情...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">15:45:55.597 d04.ThreadStartAndRun [main] - 开始运行...</span><br><span class="line">15:45:55.599 d04.ResourceReadUtil [main] - 开始读取资源 - /d04/ultra_man.mp4</span><br><span class="line">15:45:55.600 d04.ResourceReadUtil [main] - 结束读取文件 - /d04/ultra_man.mp4 - 总计花费时间 - 1毫秒</span><br><span class="line">15:45:55.600 d04.ThreadStartAndRun [main] - 做其他事情...</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p>错误的使用方式！直接调用<code>run()</code>方法将被主线程作为 <code>t1</code> 对象的普通方法调，而不是通过新创建的线程调用，程序仍在 <code>main</code> 线程运行，<code>ResourceReadUtil.read()</code> 方法调用还是同步的，将上述代码的<code>t1.run()</code>改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">t1.start();</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">15:47:48.466 d04.ThreadStartAndRun [main] - 做其他事情...</span><br><span class="line">15:47:48.466 d04.ThreadStartAndRun [t1] - 开始运行...</span><br><span class="line">15:47:48.470 d04.ResourceReadUtil [t1] - 开始读取资源 - /d04/ultra_man.mp4</span><br><span class="line">15:47:48.472 d04.ResourceReadUtil [t1] - 结束读取文件 - /d04/ultra_man.mp4 - 总计花费时间 - 1毫秒</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p>读取文件的操作在 <code>t1</code> 线程运行， <code>ResourceReadUtil.read()</code> 方法调用是异步的。</p>
<h3 id="sleep-与-yield"><a href="#sleep-与-yield" class="headerlink" title="sleep 与 yield"></a>sleep 与 yield</h3><h4 id="sleep"><a href="#sleep" class="headerlink" title="sleep"></a>sleep</h4><ol>
<li>调用 <code>Thread.sleep(long millis)</code> 会让当前线程从 <code>Running </code>进入 <code>Timed Waiting</code> 状态（阻塞）。</li>
<li>其它线程可以使用 <code>Thread.interrupt()</code>方法打断正在睡眠的线程，这时 <code>Thread.sleep(long millis)</code> 方法会抛出 <code>InterruptedException</code>。</li>
<li>睡眠结束后的线程未必会立刻得到执行（若 CPU 此时在调度其他线程，则需其他线程调度完毕才能继续执行当前睡眠结束后的线程）。</li>
<li>建议用  <code>TimeUnit </code>的 <code>sleep(long timeout)</code> 代替  <code>Thread.sleep(long millis)</code> 来获得更好的可读性，如：<code>TimeUnit.SECONDS.sleep(1)</code>。</li>
</ol>
<p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.ThreadSleep&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadSleep</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;线程t1状态: &#123;&#125;&quot;</span>, t1.getState());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            主线程短暂睡眠后再去获取t1线程状态 避免主线程执行过快 t1线程还未进入睡眠状态 获取到的t1线程状态不正确</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;线程t1状态: &#123;&#125;&quot;</span>, t1.getState());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">16:02:04.418 d04.ThreadSleep [main] - 线程t1状态: RUNNABLE</span><br><span class="line">16:02:04.934 d04.ThreadSleep [main] - 线程t1状态: TIMED_WAITING</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.ThreadSleepWithTimeUnit&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadSleepWithTimeUnit</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;开始睡眠...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        可读性差的写法</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        良好的可读性 JDK1.5后新增</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;结束睡眠...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">16:03:40.177 d04.ThreadSleepWithTimeUnit [main] - 开始睡眠...</span><br><span class="line">16:03:42.195 d04.ThreadSleepWithTimeUnit [main] - 结束睡眠...</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<h4 id="yield"><a href="#yield" class="headerlink" title="yield"></a>yield</h4><ol>
<li>调用 <code>Thread.yield()</code> （单词字面意思为让出）会让当前线程从  <code>Running </code> 进入  <code>Runnable</code> 就绪状态，然后调度执行其它线程。</li>
<li>具体的实现依赖于操作系统的任务调度器。</li>
</ol>
<p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadYield</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Runnable task1 = () -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;----&gt;线程1 &quot;</span> + count++);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Runnable task2 = () -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">                Thread.yield();</span><br><span class="line">                System.out.println(<span class="string">&quot;              ----&gt;线程2 &quot;</span> + count++);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(task1, <span class="string">&quot;线程1&quot;</span>);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(task2, <span class="string">&quot;线程2&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437656</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437657</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437658</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437659</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437660</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437661</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437662</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437663</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437664</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437665</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437666</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437667</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437668</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437669</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437670</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437671</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437672</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437673</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437674</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437675</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437676</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437677</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437678</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437679</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437680</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437681</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437682</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437683</span></span><br><span class="line">              ----&gt;线程2 154125</span><br><span class="line">              ----&gt;线程2 154126</span><br><span class="line">              ----&gt;线程2 154127</span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437684</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437685</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437686</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437687</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437688</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437689</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437690</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437691</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 437692</span></span><br></pre></td></tr></table></figure>

<p>通过设置线程的优先级能达到相同的效果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPriority</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Runnable task1 = () -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;----&gt;线程1 &quot;</span> + count++);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Runnable task2 = () -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;              ----&gt;线程2 &quot;</span> + count++);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(task1, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(task2, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        t1.setPriority(Thread.MIN_PRIORITY);</span><br><span class="line">        t2.setPriority(Thread.MAX_PRIORITY);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 165616</span></span><br><span class="line">              ----&gt;线程2 207421</span><br><span class="line">              ----&gt;线程2 207422</span><br><span class="line">              ----&gt;线程2 207423</span><br><span class="line">              ----&gt;线程2 207424</span><br><span class="line">              ----&gt;线程2 207425</span><br><span class="line">              ----&gt;线程2 207426</span><br><span class="line">              ----&gt;线程2 207427</span><br><span class="line">              ----&gt;线程2 207428</span><br><span class="line">              ----&gt;线程2 207429</span><br><span class="line">              ----&gt;线程2 207430</span><br><span class="line">              ----&gt;线程2 207431</span><br><span class="line">              ----&gt;线程2 207432</span><br><span class="line">              ----&gt;线程2 207433</span><br><span class="line">              ----&gt;线程2 207434</span><br><span class="line">              ----&gt;线程2 207435</span><br><span class="line">              ----&gt;线程2 207436</span><br><span class="line">              ----&gt;线程2 207437</span><br><span class="line">              ----&gt;线程2 207438</span><br><span class="line">              ----&gt;线程2 207439</span><br><span class="line">              ----&gt;线程2 207440</span><br><span class="line">              ----&gt;线程2 207441</span><br><span class="line">              ----&gt;线程2 207442</span><br><span class="line">              ----&gt;线程2 207443</span><br><span class="line">              ----&gt;线程2 207444</span><br><span class="line">              ----&gt;线程2 207445</span><br><span class="line">              ----&gt;线程2 207446</span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 165617</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 165618</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 165619</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 165620</span></span><br><span class="line">              ----&gt;线程2 207447</span><br><span class="line">              ----&gt;线程2 207448</span><br><span class="line">              ----&gt;线程2 207449</span><br><span class="line">              ----&gt;线程2 207450</span><br><span class="line">              ----&gt;线程2 207451</span><br><span class="line">              ----&gt;线程2 207452</span><br><span class="line">              ----&gt;线程2 207453</span><br><span class="line">              ----&gt;线程2 207454</span><br><span class="line">              ----&gt;线程2 207455</span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 165621</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 165622</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 165623</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 165624</span></span><br><span class="line">              ----&gt;线程2 207456</span><br><span class="line">              ----&gt;线程2 207457</span><br><span class="line">              ----&gt;线程2 207458</span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 165625</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 165626</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 165627</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 165628</span></span><br><span class="line">              ----&gt;线程2 207459</span><br><span class="line">              ----&gt;线程2 207460</span><br><span class="line">              ----&gt;线程2 207461</span><br><span class="line">              ----&gt;线程2 207462</span><br><span class="line">              ----&gt;线程2 207463</span><br><span class="line">              ----&gt;线程2 207464</span><br><span class="line">              ----&gt;线程2 207465</span><br><span class="line">              ----&gt;线程2 207466</span><br><span class="line">              ----&gt;线程2 207467</span><br><span class="line">              ----&gt;线程2 207468</span><br><span class="line">              ----&gt;线程2 207469</span><br><span class="line">              ----&gt;线程2 207470</span><br><span class="line">              ----&gt;线程2 207471</span><br><span class="line">              ----&gt;线程2 207472</span><br><span class="line">              ----&gt;线程2 207473</span><br><span class="line">              ----&gt;线程2 207474</span><br><span class="line">              ----&gt;线程2 207475</span><br><span class="line">              ----&gt;线程2 207476</span><br><span class="line">              ----&gt;线程2 207477</span><br><span class="line">              ----&gt;线程2 207478</span><br><span class="line">              ----&gt;线程2 207479</span><br><span class="line">              ----&gt;线程2 207480</span><br><span class="line">              ----&gt;线程2 207481</span><br><span class="line">              ----&gt;线程2 207482</span><br><span class="line">              ----&gt;线程2 207483</span><br><span class="line">              ----&gt;线程2 207484</span><br><span class="line">              ----&gt;线程2 207485</span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 165629</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 165630</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 165631</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 165632</span></span><br><span class="line"><span class="meta">----&gt;</span><span class="bash">线程1 165633</span></span><br></pre></td></tr></table></figure>

<h4 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h4><ul>
<li>调用<code>Thread.sleep(long millis)</code>使线程进从从 <code>Running </code>进入 <code>Timed Waiting</code> 状态（阻塞），<code>Timed Waiting</code>不会被 CPU 调度。</li>
<li>调用 <code>Thread.yield()</code> 会让当前线程从  <code>Running </code> 进入  <code>Runnable</code> 就绪状态，处于 <code>Runnable</code> 就绪状态的线程仍有机会被 CPU 调度。</li>
</ul>
<h4 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h4><p><a href="/e01-optimize-use/">并发实战（一）优化与应用</a></p>
<ul>
<li>使用多线程充分利用处理器</li>
<li>限制对 CPU 的使用</li>
</ul>
<h3 id="join"><a href="#join" class="headerlink" title="join"></a>join</h3><h4 id="join-使用"><a href="#join-使用" class="headerlink" title="join 使用"></a>join 使用</h4><p><code>join()</code> 的作用，为什么要使用 <code>join()</code> ？执行下面的代码，<code>r</code> 的结果是什么?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.ThreadJoin&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadJoin</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> r = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125;线程开始运行..&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            String threadName = Thread.currentThread().getName();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;&#123;&#125;线程开始运行..&quot;</span>, threadName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;&#123;&#125;线程结束运行..&quot;</span>, threadName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            r = <span class="number">10</span>;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//t1.join();</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;结果为：&#123;&#125;&quot;</span>, r);</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125;线程结束运行..&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">16:56:05.623 d04.ThreadJoin [main] - main线程开始运行..</span><br><span class="line">16:56:05.655 d04.ThreadJoin [main] - 结果为：0</span><br><span class="line">16:56:05.655 d04.ThreadJoin [main] - main线程结束运行..</span><br><span class="line">16:56:05.655 d04.ThreadJoin [t1] - t1线程开始运行..</span><br><span class="line">16:56:06.671 d04.ThreadJoin [t1] - t1线程结束运行..</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p>代码分析：</p>
<p><img src="/juc/d04-java-thread/thread-join.png"></p>
<ul>
<li>因为主线程和线程 <code>t1</code> 是并行执行的，<code>t1</code> 线程需要 <code>1</code> 秒之后才能算出 <code>r=10</code>。</li>
<li>而主线程一开始就要打印 <code>r</code> 的结果，所以只能打印出 <code>r=0</code>。</li>
</ul>
<p>使用 <code>Thread.sleep(long millis)</code>行不行？为什么？答：不行，假设 <code>t1</code> 线程运行时间不确定，此时 <code>Thread.sleep(long millis)</code>方法的睡眠时长参数将无法确定。</p>
<p>解决方案：使用 <code>Thread</code> 对象的 <code>join()</code> 方法，加在 <code>t1.start()</code> 之后即可。</p>
<p>上面的示例代码在线程启动后调用<code>Thread</code> 对象的 <code>join()</code> 方法，执行结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">16:57:52.718 d04.ThreadJoin [main] - main线程开始运行..</span><br><span class="line">16:57:52.750 d04.ThreadJoin [t1] - t1线程开始运行..</span><br><span class="line">16:57:53.765 d04.ThreadJoin [t1] - t1线程结束运行..</span><br><span class="line">16:57:53.765 d04.ThreadJoin [main] - 结果为：10</span><br><span class="line">16:57:53.765 d04.ThreadJoin [main] - main线程结束运行..</span><br><span class="line">    </span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<h4 id="join-多个"><a href="#join-多个" class="headerlink" title="join 多个"></a>join 多个</h4><p>问，下面代码大约花费多少秒？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.ThreadJoinMulti&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadJoinMulti</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> r1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> r2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            r1 = <span class="number">10</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            r2 = <span class="number">20</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;开始join线程t1&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        t1.join();</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;结束join线程t1&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;开始join线程t2&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        t2.join();</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;结束join线程t2&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;r1:&#123;&#125;, r2:&#123;&#125;, 花费时间:&#123;&#125;&quot;</span>, r1, r2, (end - start));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">17:16:49.848 d04.ThreadJoinMulti [main] - 开始join线程t1</span><br><span class="line">17:16:50.858 d04.ThreadJoinMulti [main] - 结束join线程t1</span><br><span class="line">17:16:50.858 d04.ThreadJoinMulti [main] - 开始join线程t2</span><br><span class="line">17:16:51.852 d04.ThreadJoinMulti [main] - 结束join线程t2</span><br><span class="line">17:16:51.852 d04.ThreadJoinMulti [main] - r1:10, r2:20, 花费时间:2005</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p>分析如下</p>
<ul>
<li>第一个 <code>join</code> ：主线程等待 <code>t1</code> 时, <code>t2</code>在继续运行。</li>
<li>第二个 <code>join</code> ：<code>1s</code> 后, 主线程执行到此, <code>t2</code> 运行了 <code>1s</code>, 因此只需再等待 <code>1s</code>。</li>
</ul>
<p>如果颠倒两个 <code>join</code> 呢？</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">17:21:50.710 d04.ThreadJoinMulti [main] - 开始join线程t2</span><br><span class="line">17:21:52.715 d04.ThreadJoinMulti [main] - 结束join线程t2</span><br><span class="line">17:21:52.715 d04.ThreadJoinMulti [main] - 开始join线程t1</span><br><span class="line">17:21:52.715 d04.ThreadJoinMulti [main] - 结束join线程t1</span><br><span class="line">17:21:52.715 d04.ThreadJoinMulti [main] - r1:10, r2:20, 花费时间:2006</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p>结果仍为 <code>2</code> 秒，因为 <code>sleep</code> 方法不占用 CPU 时间片,无论是单核还是多核 CPU 结果都一样。</p>
<h4 id="join-时效"><a href="#join-时效" class="headerlink" title="join 时效"></a>join 时效</h4><p><code>Thread</code>提供了一个有时效的 <code>join(long millis)</code>方法，其效果为：</p>
<p>当等待时间小于被等待线程执行时间时，将结束等待（未等够执行时间）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.ThreadJoinTimeout&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadJoinTimeout</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> r1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> r2 = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            r1 = <span class="number">10</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(log.isDebugEnabled())&#123;</span><br><span class="line">            log.debug(<span class="string">&quot;开始join...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        t1.join(<span class="number">1500</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        log.debug(<span class="string">&quot;r1: &#123;&#125; r2: &#123;&#125; ,花费时间: &#123;&#125;&quot;</span>, r1, r2, end - start);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">17:31:32.612 d04.ThreadJoinTimeout [main] - 开始join...</span><br><span class="line">17:31:34.119 d04.ThreadJoinTimeout [main] - r1: 0 r2: 0 ,花费时间: 15</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p>当等待时间大于被等待线程执行时间时，被等待的线程执行结束会导致调用 <code>join</code> 的线程提前结束等待（已等够执行时间）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.ThreadJoinTimeout&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadJoinTimeout</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> r1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> r2 = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            r1 = <span class="number">10</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(log.isDebugEnabled())&#123;</span><br><span class="line">            log.debug(<span class="string">&quot;开始join...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        t1.join(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        log.debug(<span class="string">&quot;r1: &#123;&#125; r2: &#123;&#125; ,花费时间: &#123;&#125;&quot;</span>, r1, r2, end - start);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">17:33:44.380 d04.ThreadJoinTimeout [main] - 开始join...</span><br><span class="line">17:33:46.383 d04.ThreadJoinTimeout [main] - r1: 10 r2: 0 ,花费时间: 2004</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<h3 id="interrupt"><a href="#interrupt" class="headerlink" title="interrupt"></a>interrupt</h3><p>这里根据线程运行状态，将<code>interrupt()</code> 的使用归纳为以下两种场景：</p>
<ol>
<li>打断处于阻塞状态的线程：<code>sleep</code>，<code>wait</code>，<code>join</code>这几个方法都会让线程进入阻塞状态，<code>interrupt()</code>这种状态下的线程会抛出<code>InterruptedException</code>，并清空线程的打断标记。</li>
<li>打处于正常运行的线程断：不会清空打断标记，并且不会打断要被打断的线程，只是设定打断标记为<code>true</code>，被<code>interrupt()</code>线程根据打断标记自行处理是否继续执行。</li>
</ol>
<p>注：线程打断标记被清空后其值为 <code>fasle</code> ，被设置时其值为 <code>true</code> 。</p>
<h4 id="打断阻塞状态线程"><a href="#打断阻塞状态线程" class="headerlink" title="打断阻塞状态线程"></a>打断阻塞状态线程</h4><p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.ThreadBlockedInterrupt&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadBlockedInterrupt</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;开始睡眠&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">5</span>); <span class="comment">// sleep, wait, join</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            主线程睡眠1秒后再执行打断 避免执行过快 t1 线程未进入睡眠</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;执行打断&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        t1.interrupt();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125;线程打断标记：&#123;&#125;&quot;</span>, t1.getName(), t1.isInterrupted());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">17:42:19.030 d04.ThreadBlockedInterrupt [t1] - 开始睡眠</span><br><span class="line">17:42:20.033 d04.ThreadBlockedInterrupt [main] - 执行打断</span><br><span class="line">17:42:20.033 d04.ThreadBlockedInterrupt [main] - t1线程打断标记：false</span><br><span class="line">java.lang.InterruptedException: sleep interrupted</span><br><span class="line">	at java.lang.Thread.sleep(Native Method)</span><br><span class="line">	at java.lang.Thread.sleep(Thread.java:340)</span><br><span class="line">	at java.util.concurrent.TimeUnit.sleep(TimeUnit.java:386)</span><br><span class="line">	at d04.ThreadBlockedInterrupt.lambda$main$0(ThreadBlockedInterrupt.java:15)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748)</span><br><span class="line">	</span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<h4 id="打断正常运行线程"><a href="#打断正常运行线程" class="headerlink" title="打断正常运行线程"></a>打断正常运行线程</h4><p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.ThreadNonBlockedInterrupt&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadNonBlockedInterrupt</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;开始执行&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;开始执行&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> interrupted = Thread.currentThread().isInterrupted();</span><br><span class="line">                <span class="keyword">if</span> (interrupted) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                        log.debug(<span class="string">&quot;检测到打断标记退出循环&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;结束执行&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;执行打断&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        interrupt方法并不会打断正常运行的线程，只会设置线程的打断标记为true</span></span><br><span class="line"><span class="comment">        被打断线程根据打断标记来自行决定是否停止运行，这是一种优雅的方式</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        t1.interrupt();</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;结束执行&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">17:43:03.777 d04.ThreadNonBlockedInterrupt [main] - 开始执行</span><br><span class="line">17:43:03.811 d04.ThreadNonBlockedInterrupt [t1] - 开始执行</span><br><span class="line">17:43:04.822 d04.ThreadNonBlockedInterrupt [main] - 执行打断</span><br><span class="line">17:43:04.822 d04.ThreadNonBlockedInterrupt [main] - 结束执行</span><br><span class="line">17:43:04.822 d04.ThreadNonBlockedInterrupt [t1] - 检测到打断标记退出循环</span><br><span class="line">17:43:04.822 d04.ThreadNonBlockedInterrupt [t1] - 结束执行</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<h4 id="interrupt-和-interrupted"><a href="#interrupt-和-interrupted" class="headerlink" title="interrupt 和 interrupted"></a>interrupt 和 interrupted</h4><ul>
<li><code>interrupt()</code>：不会清除打断标记。</li>
<li><code>interrupted()</code>：会清除打断标记。</li>
</ul>
<p>使用时要特别注意这两个方法对打断标记的作用效果。</p>
<h4 id="interrupt-和-park"><a href="#interrupt-和-park" class="headerlink" title="interrupt 和 park"></a>interrupt 和 park</h4><p>当<code>interrupt()</code>打断 <code>LockSupport.park()</code> 的线程时， 不会清空该线程的打断标记。</p>
<p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.ThreadParkInterrupt1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadParkInterrupt1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;park...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LockSupport.park();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;unpark by interrupt&quot;</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;打断状态：&#123;&#125;&quot;</span>, Thread.currentThread().isInterrupted());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        t.start();</span><br><span class="line"></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        t.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">17:55:29.839 d04.ThreadParkInterrupt1 [Thread-0] - park...</span><br><span class="line">17:55:30.853 d04.ThreadParkInterrupt1 [Thread-0] - unpark</span><br><span class="line">17:55:30.853 d04.ThreadParkInterrupt1 [Thread-0] - 打断状态：true</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p>如果打断标记已经是 <code>true</code>, 则 <code>park()</code>会失效：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.ThreadParkInterrupt2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadParkInterrupt2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;park...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LockSupport.park();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;unpark by interrupt&quot;</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;打断状态：&#123;&#125;&quot;</span>, Thread.currentThread().isInterrupted());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LockSupport.park();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;invalid park&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        t.start();</span><br><span class="line"></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        t.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">18:05:01.862 d04.ThreadParkInterrupt2 [Thread-0] - park...</span><br><span class="line">18:05:02.863 d04.ThreadParkInterrupt2 [Thread-0] - unpark by interrupt</span><br><span class="line">18:05:02.863 d04.ThreadParkInterrupt2 [Thread-0] - 打断状态：true</span><br><span class="line">18:05:02.864 d04.ThreadParkInterrupt2 [Thread-0] - invalid park</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p>此时应该使用之前提到过的<code>Thread.interruped()</code>清空打断标记使<code>LockSupport.park()</code>重新生效：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.ThreadParkInterrupt3&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadParkInterrupt3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;park...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LockSupport.park();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;unpark by interrupt&quot;</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;打断状态：&#123;&#125;&quot;</span>, Thread.interrupted());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LockSupport.park();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;unpark&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        t.start();</span><br><span class="line"></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        t.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">18:06:20.091 d04.ThreadParkInterrupt3 [Thread-0] - park...</span><br><span class="line">18:06:21.105 d04.ThreadParkInterrupt3 [Thread-0] - unpark by interrupt</span><br><span class="line">18:06:21.105 d04.ThreadParkInterrupt3 [Thread-0] - 打断状态：true</span><br></pre></td></tr></table></figure>

<p>从执行结果可以看出程序仍在继续执行，日志中未输出 <code>unpark</code>。</p>
<h4 id="两阶段终止模式"><a href="#两阶段终止模式" class="headerlink" title="两阶段终止模式"></a>两阶段终止模式</h4><p><a href="/e02-pattern-use/">并发实战（二）模式与应用</a></p>
<ul>
<li>两阶段终止模式</li>
</ul>
<h2 id="过时不推荐使用的方法"><a href="#过时不推荐使用的方法" class="headerlink" title="过时不推荐使用的方法"></a>过时不推荐使用的方法</h2><p>还有一些不推荐使用的方法，这些方法已过时，容易破坏同步代码块，造成线程死锁，使用的时候需谨慎：</p>
<table>
<thead>
<tr>
<th>方法名</th>
<th>static</th>
<th>功能说明</th>
<th>替代</th>
</tr>
</thead>
<tbody><tr>
<td><code>stop()</code></td>
<td></td>
<td>停止线程运行</td>
<td>两阶段终止模式</td>
</tr>
<tr>
<td><code>suspend()</code></td>
<td></td>
<td>挂起（暂停）线程运行</td>
<td><code>wait()</code></td>
</tr>
<tr>
<td><code>resume()</code></td>
<td></td>
<td>恢复线程运行</td>
<td><code>notify()</code></td>
</tr>
</tbody></table>
<h2 id="非守护线程与守护线程"><a href="#非守护线程与守护线程" class="headerlink" title="非守护线程与守护线程"></a>非守护线程与守护线程</h2><p>默认情况下，Java 进程需要等待所有非守护线程都运行结束，才会结束。</p>
<p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 只要有一个前台（非守护）线程还在运行，Java进程就不会结束</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.ThreadDaemonNon&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadDaemonNon</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;非守护子线程结束运行..&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;主线程结束运行..&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">18:10:12.347 d04.ThreadDaemonNon [main] - 主线程结束运行..</span><br></pre></td></tr></table></figure>

<p>从执行结果可以看出主线程执行完毕后程序仍在继续执行。</p>
<p>有一种特殊的线程叫做守护线程，<strong>只要其它非守护线程运行结束了，即使守护线程的代码没有执行完，也会强制结束</strong>。</p>
<p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.ThreadDaemon&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadDaemon</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;开始运行...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;开始运行...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;运行结束...&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;daemon&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        设置该线程为守护线程</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        t1.setDaemon(<span class="keyword">true</span>);<span class="comment">//</span></span><br><span class="line">        t1.start();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        若在线程启动后再设置为守护线程会抛出IllegalThreadStateException</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//t1.setDaemon(true);</span></span><br><span class="line"></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;结束运行...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">18:12:46.623 d04.ThreadDaemon [main] - 开始运行...</span><br><span class="line">18:12:46.653 d04.ThreadDaemon [daemon] - 开始运行...</span><br><span class="line">18:12:47.655 d04.ThreadDaemon [main] - 结束运行...</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong></p>
<ul>
<li>JVM垃圾回收器线程就是一种守护线程</li>
<li>Tomcat 中的 Acceptor 和 Poller 线程都是守护线程，所以 Tomcat 接收到 shutdown 命令后，不会等待它们处理完当前请求</li>
</ul>
<h2 id="线程五大状态"><a href="#线程五大状态" class="headerlink" title="线程五大状态"></a>线程五大状态</h2><p>从操作系统层面来看，线程有以下五大状态：</p>
<p><img src="/juc/d04-java-thread/thread-five-system-state.png"></p>
<ul>
<li><p><strong>初始状态</strong>：仅是在语言层面创建了线程对象，还未与操作系统线程关联。</p>
</li>
<li><p><strong>就绪状态</strong>：指该线程已经被创建（与操作系统线程关联），可以由 CPU 调度执行。</p>
</li>
<li><p><strong>运行状态</strong>：指获取了 CPU 时间片运行中的状态。</p>
<ul>
<li>当 CPU 时间片用完，会从<strong>运行状态</strong>转换至<strong>就绪状态</strong>，会导致线程的上下文切换。</li>
</ul>
</li>
<li><p><strong>阻塞状态</strong>：</p>
<ul>
<li><p>如果调用了阻塞 API，如 BIO 读写文件，这时该线程实际不会用到 CPU，会导致线程上下文切换，进入<strong>阻塞状态</strong>。</p>
</li>
<li><p>等 BIO 操作完毕，会由操作系统唤醒阻塞的线程，转换至<strong>就绪状态</strong>。</p>
</li>
<li><p>与<strong>就绪状态</strong>的区别是，对<strong>阻塞状态</strong>的线程来说只要它们一直不唤醒，调度器就一直不会考虑调度它们。</p>
</li>
</ul>
</li>
<li><p><strong>终止状态:</strong> 表示线程已经执行完毕，生命周期已经结束，不会再转换为其它状态。</p>
</li>
</ul>
<h2 id="线程六大状态"><a href="#线程六大状态" class="headerlink" title="线程六大状态"></a>线程六大状态</h2><p>从 Java API 层面来讲，根据 <code>Thread.State</code> 枚举，分为六种状态：</p>
<p><img src="/juc/d04-java-thread/thread-six-system-state.png"></p>
<ul>
<li><p><code>NEW </code>线程刚被创建，但是还没有调用 <code>start()</code> 方法。</p>
</li>
<li><p><code>RUNNABLE</code>当调用了 <code>start()</code> 方法之后，注意，Java API 层面的 <code>RUNNABLE</code>状态涵盖了 操作系统 层面的<strong>就绪状态</strong>、<strong>运行状态</strong>和<strong>阻塞状态</strong>（由于 BIO 导致的线程阻塞，在 Java 里无法区分，仍然认为是可运行）。</p>
</li>
<li><p><code>BLOCKED</code>， <code>WAITING </code>， <code>TIMED_WAITING </code>都是 Java API 层面对<strong>阻塞状态</strong>的细分，后面会在状态转换一节详述。</p>
</li>
<li><p><code>TERMINATED</code>当线程代码运行结束。</p>
</li>
</ul>
<p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.ThreadState&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadState</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        t1线程初始化之后但一直未启动，状态为NEW</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;开始执行...&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        t2线程处于一直运行中，状态为RUNNABLE</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(<span class="string">&quot;t2&quot;</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="comment">// RUNNABLE</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t2.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        t3线程将正常运行完毕，状态为TERMINATED</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Thread t3 = <span class="keyword">new</span> Thread(<span class="string">&quot;t3&quot;</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;开始执行...&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t3.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        t4线程调用sleep方法，状态为TIMED_WAITING，即有时限的等待</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Thread t4 = <span class="keyword">new</span> Thread(<span class="string">&quot;t4&quot;</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (ThreadState.class) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000000</span>); <span class="comment">// TIMED_WAITING</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t4.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        t5线程中调用了t2的无参join方法，由于没有传入时间，t5的状态为WAITING，即无时限等待</span></span><br><span class="line"><span class="comment">        若调用带时间参数的join方法，状态为TIMED_WAITING，即有时限的等待</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Thread t5 = <span class="keyword">new</span> Thread(<span class="string">&quot;t5&quot;</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    t2.join(); <span class="comment">// WAITING</span></span><br><span class="line">                    <span class="comment">//t2.join(100000); // TIMED_WAITING</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t5.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        t6线程和t4线程使用同一个锁对象，但t4线程先获得锁，并一直运行，此时t6将无法获得锁，其状态为 BLOCKED</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Thread t6 = <span class="keyword">new</span> Thread(<span class="string">&quot;t6&quot;</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (ThreadState.class) &#123; <span class="comment">// BLOCKED</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        t6.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;t1 state &#123;&#125;&quot;</span>, t1.getState());</span><br><span class="line">        log.debug(<span class="string">&quot;t2 state &#123;&#125;&quot;</span>, t2.getState());</span><br><span class="line">        log.debug(<span class="string">&quot;t3 state &#123;&#125;&quot;</span>, t3.getState());</span><br><span class="line">        log.debug(<span class="string">&quot;t4 state &#123;&#125;&quot;</span>, t4.getState());</span><br><span class="line">        log.debug(<span class="string">&quot;t5 state &#123;&#125;&quot;</span>, t5.getState());</span><br><span class="line">        log.debug(<span class="string">&quot;t6 state &#123;&#125;&quot;</span>, t6.getState());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">18:25:07.026 d04.ThreadState [t3] - 开始执行...</span><br><span class="line">18:25:07.538 d04.ThreadState [main] - t1 state NEW</span><br><span class="line">18:25:07.539 d04.ThreadState [main] - t2 state RUNNABLE</span><br><span class="line">18:25:07.539 d04.ThreadState [main] - t3 state TERMINATED</span><br><span class="line">18:25:07.539 d04.ThreadState [main] - t4 state TIMED_WAITING</span><br><span class="line">18:25:07.539 d04.ThreadState [main] - t5 state WAITING</span><br><span class="line">18:25:07.539 d04.ThreadState [main] - t6 state BLOCKED</span><br></pre></td></tr></table></figure>

<h2 id="统筹方法应用"><a href="#统筹方法应用" class="headerlink" title="统筹方法应用"></a>统筹方法应用</h2><p>华罗庚《统筹方法》，是一种安排工作进程的数学方法。它的实用范围极广泛，在企业管理和基本建设中，以及关系复杂的科研项目的组织与管理中，都可以应用。怎样应用呢？主要是把工序安排好。</p>
<p>比如，想泡壶茶喝。当时的情况是：开水没有；水壶要洗，茶壶、茶杯要洗；火已生了，茶叶也有了。怎么办？</p>
<ol>
<li><p>洗好水壶，灌上凉水，放在火上；在等待水开的时间里，洗茶壶、洗茶杯、拿茶叶；等水开了，泡茶喝。（并行）。</p>
</li>
<li><p>先做好一些准备工作，洗水壶，洗茶壶茶杯，拿茶叶；一切就绪，灌水烧水；坐待水开了，泡茶喝。（串行）。</p>
</li>
<li><p>洗净水壶，灌上凉水，放在火上，坐待水开；水开了之后，急急忙忙找茶叶，洗茶壶茶杯，泡茶喝。（串行）</p>
</li>
</ol>
<p>哪一种办法省时间？我们能一眼看出，第一种办法好，后两种办法都窝了工。这是小事，但这是引子，可以引出生产管理等方面有用的方法来。</p>
<p>水壶不洗，不能烧开水，因而洗水壶是烧开水的前提。没开水、没茶叶、不洗茶壶茶杯，就不能泡茶，因而这些又是泡茶的前提。它们的相互关系，可以用下边的箭头图来表示：</p>
<p><img src="/juc/d04-java-thread/plan-as-a-whole1.png"></p>
<p>从这个图上可以一眼看出，方法一总共要16分钟（而方法二、三需要20分钟）。如果要缩短工时、提高工作效率，应当主要抓烧开水这个环节，而不是抓拿茶叶等环节。同时，洗茶壶茶杯、拿茶叶总共不过4分钟，大可利用“等水开”的时间来做。</p>
<p>是的，这好像是废话，卑之无甚高论。有如走路要用两条腿走，吃饭要一口一口吃，这些道理谁都懂得。但稍有变化，临事而迷的情况，常常是存在的。在近代工业的错综复杂的工艺过程中，往往就不是像泡茶喝这么简单了。</p>
<p>任务多了，几百几千，甚至有好几万个任务。关系多了，错综复杂，千头万绪，往往出现“万事俱备，只欠东风”的情况。由于一两个零件没完成，耽误了一台复杂机器的出厂时间。或往往因为抓的不是关键，连夜三班，急急忙忙，完成这一环节之后，还得等待旁的环节才能装配。</p>
<p>洗茶壶，洗茶杯，拿茶叶，或先或后，关系不大，而且同是一个人的活儿，因而可以合并成为：</p>
<p><img src="/juc/d04-java-thread/plan-as-a-whole2.png"></p>
<p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;d04.ThreadPlanAsAWhole&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPlanAsAWhole</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;洗水壶&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;烧开水&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">15</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;老王&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;洗茶壶&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;洗茶杯&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;拿茶叶&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t1.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;泡茶&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;小王&quot;</span>);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">18:30:32.039 d04.ThreadPlanAsAWhole [老王] - 洗水壶</span><br><span class="line">18:30:32.039 d04.ThreadPlanAsAWhole [小王] - 洗茶壶</span><br><span class="line">18:30:33.047 d04.ThreadPlanAsAWhole [小王] - 洗茶杯</span><br><span class="line">18:30:33.047 d04.ThreadPlanAsAWhole [老王] - 烧开水</span><br><span class="line">18:30:35.053 d04.ThreadPlanAsAWhole [小王] - 拿茶叶</span><br><span class="line">18:30:48.058 d04.ThreadPlanAsAWhole [小王] - 泡茶</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>赏小弟喝杯奶茶(●'◡'●)!!!</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/alipay.png" alt="Long Shiyu 支付宝">
        <span>支付宝</span>
      </div>
      <div>
        <img src="/images/wechatpay.png" alt="Long Shiyu 微信">
        <span>微信</span>
      </div>

  </div>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/juc/d05-shared-model/" rel="prev" title="并发编程（五）模型之共享">
                  <i class="fa fa-chevron-left"></i> 并发编程（五）模型之共享
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/juc/d03-synchronous-asynchronous/" rel="next" title="并发编程（三）同步与异步">
                  并发编程（三）同步与异步 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2020 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Long Shiyu</span>
</div>

    </div>
  </footer>

  
  <script src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"forest","dark":"forest"},"js":{"url":"https://unpkg.com/mermaid@8.13.8/dist/mermaid.min.js","integrity":"sha256-QmSAc2kIaUjleIJ46X7qPW2zrpCbXlMz3YIGgWpQ1Jo="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>



  





</body>
</html>
